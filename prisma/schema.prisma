/*
File: prisma/schema.prisma
(This is the complete, final schema)
*/

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// ------------------------------------------
// ENUMS
// ------------------------------------------

enum Role {
  STUDENT
  CLUB_MANAGER
  DSW_OFFICIAL
}

enum EventStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  COMPLETED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ------------------------------------------
// MODELS
// ------------------------------------------

model User {
  id        String @id @default(cuid())
  clerkId   String @unique
  email     String @unique
  firstName String?
  lastName  String?
  role      Role   @default(STUDENT)
  imageUrl  String?

  // Relations
  clubManaged     Club?          @relation("ClubManager")
  createdEvents   Event[]        @relation("CreatedBy")
  approvals       EventApproval[] @relation("ReviewedBy")
  registrations   Registration[] @relation("RegisteredStudent")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Club {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?

  managerId String @unique
  manager   User   @relation("ClubManager", fields: [managerId], references: [clerkId])

  events Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String
  date        DateTime
  venue       String
  status      EventStatus @default(DRAFT)
  
  // Notesheet fields are now included from the start
  objectives    String
  beneficiaries String
  schedule      String
  requirements  String?
  creativeUrl   String?

  // Relations
  creatorId String
  creator   User   @relation("CreatedBy", fields: [creatorId], references: [clerkId])

  clubId String
  club   Club   @relation(fields: [clubId], references: [id])

  notesheet      Notesheet?
  approval       EventApproval?
  registrations  Registration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notesheet {
  id            String   @id @default(cuid())
  generatedText String
  formDataJson  Json
  
  eventId       String   @unique
  event         Event    @relation(fields: [eventId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventApproval {
  id        String         @id @default(cuid())
  status    ApprovalStatus @default(PENDING)
  comments  String?
  
  eventId   String         @unique
  event     Event          @relation(fields: [eventId], references: [id])
  
  reviewerId String?
  reviewer   User?   @relation("ReviewedBy", fields: [reviewerId], references: [clerkId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Registration {
  id        String   @id @default(cuid())
  qrCode    String   @unique
  checkedIn Boolean  @default(false)
  
  studentId String
  student   User   @relation("RegisteredStudent", fields: [studentId], references: [clerkId])
  
  eventId   String
  event     Event  @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([studentId, eventId])
}